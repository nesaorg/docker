
[SERVICE]
    Flush         1
    Daemon        Off
    Log_Level     info
    Parsers_File  parsers.conf

# --- Tail bootstrap log ------------------------------------------------
[INPUT]
    Name                tail
    Path                /mnt/nesa/logs/bootstrap.log
    Tag                 bootstrap
    Mem_Buf_Limit       10MB
    Skip_Long_Lines     On
    Refresh_Interval    5
    DB                  /fluent-bit/state/bootstrap.db
    # bootstrap.log lines already timestamped by your script; we leave as text

[FILTER]
    Name    modify
    Match   bootstrap
    Add     node_id     ${NODE_ID}
    Add     moniker     ${MONIKER}
    Add     public_ip   ${PUBLIC_IP}
    Add     chain_id    ${CHAIN_ID}
    Add     host        ${HOSTNAME}
    Add     level       info
    # Wrap tail line as a JSON field 'line' if needed by devsigner
    Rename  log         line

[OUTPUT]
    Name              http
    Match             bootstrap
    Host              log-signer
    Port              9000
    URI               /ingest/bootstrap
    # single line JSON per record
    Format            json_lines
    Json_date_key     ts
    Json_date_format  iso8601
    # tell devsigner which stream this is
    Header            X-Stream-Type bootstrap
    Header            X-Stream-Id   bootstrap
    Header            X-Stream-Name bootstrap

# --- Tail all docker container logs -----------------------------------
[INPUT]
    Name                tail
    Path                /var/lib/docker/containers/*/*-json.log
    Tag                 docker.*
    Parser              docker
    Mem_Buf_Limit       10MB
    Skip_Long_Lines     On
    Refresh_Interval    5
    DB                  /fluent-bit/state/docker.db

# Parse and enrich with Docker metadata (container_name, labels, etc)
[FILTER]
    Name                  docker
    Match                 docker.*
    Unix_Socket_Path      /var/run/docker.sock
    Merge_Log             On
    Keep_Log              Off
    Docker_Mode           On
    Docker_Mode_Key       log
    # If your app logs JSON, Merge_Log will flatten it

[FILTER]
    Name    modify
    Match   docker.*
    Add     node_id     ${NODE_ID}
    Add     moniker     ${MONIKER}
    Add     public_ip   ${PUBLIC_IP}
    Add     chain_id    ${CHAIN_ID}
    Add     host        ${HOSTNAME}

# Orchestrator-only stream to devsigner
[OUTPUT]
    Name              http
    Match             docker.*orchestrator*
    Host              log-signer
    Port              9000
    URI               /ingest/orchestrator
    Format            json_lines
    Json_date_key     ts
    Json_date_format  iso8601
    Header            X-Stream-Type docker
    Header            X-Stream-Id   orchestrator
    Header            X-Stream-Name orchestrator

# Watchtower (optional) to devsigner
[OUTPUT]
    Name              http
    Match             docker.*watchtower*
    Host              log-signer
    Port              9000
    URI               /ingest/watchtower
    Format            json_lines
    Json_date_key     ts
    Json_date_format  iso8601
    Header            X-Stream-Type docker
    Header            X-Stream-Id   watchtower
    Header            X-Stream-Name watchtower
